<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/codemirror-textarea/codemirror-textarea.html">
<link rel="import" href="live-demo-tab.html">

<dom-module id='live-demo-tabs'>
  <template>
    <style include="iron-flex">
      :host {
        display: block;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      paper-tabs {
        color: black;
        --paper-tabs-selection-bar-color: black;
      }

      paper-tab {
        font-size: 16px;
      }

      iron-pages {
        background: white;
        width: 100%;
        height: 100%;
      }

      paper-button {
        color: white;
        background: #1e88e5;  /* blue-600 */
        font-size: 13px;
        vertical-align: middle;
      }

      .tabstrip a {
        text-decoration: none;
      }

      iframe {
        width: 100%;
        overflow: hidden;
      }

      .results {
        box-sizing: border-box;
        background: white;
        width: 100%;
        padding: 20px;
        margin: 0;
        background-color: #fafafa;
        border-top: 1px solid #e0e0e0;
      }

    </style>

    <div class="tabstrip layout horizontal center">
      <paper-tabs selected="{{selected}}" class="flex" selectable="live-demo-tab">
        <slot></slot>
      </paper-tabs>
    </div>

     <codemirror-textarea mirror-content="{{mirrorContent}}"></codemirror-textarea> 
     <div class="results">
       <iframe id="frame" src="[[src]]" scrolling="no" frameborder="0" height$="[[height]]"></iframe>
     </div>

  </template>

  <script>
  Polymer({
    is: 'live-demo-tabs',

    properties: {
      selected: {
        type: Number,
        observer: '_selectedChanged'
      },
      htmlContent: {
        type: String,
        observer: '_htmlContentChanged'
      },
      height: {
        type: Number
      },
      src: {
        type: String
      }
    },

    listeners: {
      'html-content-changed': '_onHtmlContentChanged',
      'mirror-changed': '_onMirrorChanged'
    },

    ready: function() {
      this._htmlContents = {};
      this.selected = 0;
      this._demoHeight = this.height;
      window.addEventListener('message', this._onMessage.bind(this));
      this.$.frame.onload = this._onLoad.bind(this);
    },

    _onLoad: function() {
      this._initIframeContent();
    },

    _htmlContentChanged: function() {
      this._htmlContents[this._getSelectedTabName()] = this.htmlContent;
      this._postMessage({codeObj: this._htmlContents});
    },

    _onMirrorChanged: function(event) {
      this._fromEditor = true;
      this.htmlContent = event.detail.htmlContent;
      let selectedTab = this._getSelectedTab();
      selectedTab.fire('html-contents-changed', {htmlContent: this.htmlContent});
    },

    _onHtmlContentChanged: function(event) {
      this._htmlContents[event.detail.tabName] = event.detail.content;
      this.htmlContent = this._htmlContents[this._getSelectedTabName()];
      this._updateMirror();
    },

    _selectedChanged: function() {
      if (!this._htmlContents)
        return;
      this.htmlContent = this._htmlContents[this._getSelectedTabName()];
      this._fromEditor = false;
      this._updateMirror();
    },

    _postMessage: function(content) {  
      if (!this._frameReady)
        return;
      this.debounce('postMessage', _ => { this.$.frame.contentWindow.postMessage(content, this.src); }, 400);
    },

    _onMessage: function(event) {
      if (event.data.ready) {
        this._initIframeContent();
      } else {
        this._updateFrameHeight(event.data.height);
      }
    },

    _updateMirror: function() {
      if (!this._fromEditor) 
        this.mirrorContent = this.htmlContent;
      this._fromEditor = false;
    },

    _initIframeContent: function() {
      this._frameReady = true;
      this.$.frame.style.height = this._demoHeight;
      this._htmlContentChanged();
    },

    _updateFrameHeight: function(measuredHeight) {
      if (!this._frameReady || this.height)
        return;
      
      let oldHeight = this._demoHeight;
      let newHeight = Math.max(oldHeight, measuredHeight);
      if (newHeight !== oldHeight) {
        this._demoHeight = newHeight;
        this.$.frame.style.height = this._demoHeight.toString() + 'px';
      }
    },

    _getSelectedTab: function() {
      var childTabs = Polymer.dom(this).querySelectorAll('live-demo-tab');
      return childTabs[this.selected];
    },

    _getSelectedTabName: function() {
      return this._getSelectedTab().tabName;
    }

  });
  </script>
</dom-module>

