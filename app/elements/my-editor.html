<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="codemirror-import.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<!-- TODO: investigate why Firefox can't find style unless it's linked here  -->
<link rel="stylesheet" href="../bower_components/codemirror/lib/codemirror.css"> 

<dom-module id="my-editor">
  <link rel="stylesheet" href="../bower_components/codemirror/lib/codemirror.css">
  <template>
    <style>
      :host {
        display: block;

        padding: 10px;
      }

       :host > * {
        width: 100%;
      }       


</style>
      <template is="dom-if" if="[[!_frameReady]]">
        <paper-spinner></paper-spinner>
      </template>
      <iframe id="frame" src="[[href]]"></iframe>
      
      <div id="container" class="code-mirror-container">
        <textarea id="textarea" value="[[value]]"></textarea>
      </div>

  </template>

  <script>
    Polymer( {
      is: 'my-editor',

      properties: {
          href: String,
          // initial code, some of which is server-computed
          htmlContent: {
            type: String,
            observer: '_htmlContentChanged',
            notify: true
          },
          value: {
            type: String,
            observer: '_valueChanged'
          },
          dependencies: {
            type: Object
          }
      },

      created: function() {        
        window.addEventListener('message', this._onMessage.bind(this));
      },

      updateDemo: function() {
        this.$.frame.contentWindow.postMessage(this._codeMirror.getValue(), this.href);
      },

      _onChanges: function() {
        this.debounce('updateDemo', this.updateDemo, 400);
      },

      _valueChanged: function(value) {
        if (!this._codeMirror) 
          return;
        this._codeMirror.setValue(this.value);
      },

      // receive message from frame when its poly-editor is attached, then initialize mirror
      _onMessage: function(e) {
        if (e.origin !== this.href) {
          return;
        }

        this._frameReady = true;
        this._codeMirror = CodeMirror.fromTextArea(this.$.textarea, {
          mode: 'text/html'
        });
        this._codeMirror.on('changes', this._onChanges.bind(this));
        this._htmlContentChanged();
      },

      _htmlContentChanged: function() {
        var endScript = 'script>';
        var source = [
          '<!-- polyfill for browsers that do not support webcomponents -->',
          '<script src="../../bower_components/webcomponentsjs/webcomponents-loader.js"><' + '/'.toString() + endScript,
          '',
          this.htmlContent
        ].join('\n');
        this.value = source;
      }

    });


  </script>
</dom-module>
