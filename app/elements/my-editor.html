<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="codemirror-import.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<!-- TODO: investigate why Firefox can't find style unless it's linked here  -->
<link rel="stylesheet" href="../bower_components/codemirror/lib/codemirror.css"> 

<dom-module id="my-editor">
  <link rel="stylesheet" href="../bower_components/codemirror/lib/codemirror.css">
  <template>
    <style>
      :host {
        display: block;

        padding: 10px;
      }

      :host > * {
        width: 100%;
      }       

</style>
      <template is="dom-if" if="[[!_frameReady]]">
        <paper-spinner></paper-spinner>
      </template>
      <iframe id="frame" src="[[href]]"></iframe>
      
      <div id="container" class="code-mirror-container">
        <textarea id="textarea" value="[[displayContent]]"></textarea>
      </div>

  </template>

  <script>
    Polymer( {
      is: 'my-editor',

      properties: {
        href: String,
        validator: String,
        _demoHeight: {
          type: Number,
          observer: '_demoHeightChanged'
        },
        currHeading: {
          type: String,
          observer: '_currHeadingChanged'
        },
        htmlContent: {
          type: Object
          // observer: '_htmlContentChanged'
        }
      },

      observers: [
        '_htmlContentChanged(htmlContent.*, htmlContent)'
      ],

      created: function() {
        this.currCode = {};
      },

      ready: function() {   
        window.addEventListener('message', this._onMessage.bind(this));
        // this.addEventListener('html-content-changed', this._onHtmlContentChanged.bind(this));
      },

      validate: function() {
        if (!this.validator || !this.htmlContent)
          return;

        this._sendMessage({validator: this.validator, codeObj: this.currCode});
      },

      // handle incoming messages from child iframe
      _onMessage: function(e) {
        if (e.origin !== this.href) {
          return;
        }

        if (e.data.height) {
          this._demoHeight = Math.max(e.data.height, 200);
        } else if (e.data.valid !== undefined) {
          this.valid = e.data.valid;
        } else { // frame ready, init code mirror
          this._frameReady = e.data.ready;
          this._initCodeMirror(); 
        }
      },

      _sendMessage: function(content) {
        this.$.frame.contentWindow.postMessage(content, this.href);
      },

      _initCodeMirror: function() {
        if (!this._frameReady) // something went wrong (TODO: notify)
          return;
        this._codeMirror = CodeMirror.fromTextArea(this.$.textarea, {
          mode: 'text/html'
        });
        this._codeMirror.on('changes', this._onChanges.bind(this));
        this._currHeadingChanged();
      },

      updateDemo: function() {
        this._sendMessage({codeObj: this.currCode});
      },

      _onChanges: function() {
        this.currCode[this.currHeading] = this._codeMirror.getValue();
        this.debounce('updateDemo', this.updateDemo, 400);
      },

      // listener for html-content-changed; fired when initial content from live-demo-tabs changes
      // this is here because a wildcard observer on htmlContent and currHeading wasn't getting called when expected
      // _onHtmlContentChanged: function(event) {
      //   if (!event.detail) 
      //     return;

      //   this.currCode = event.detail.htmlContent;
      //   this._currHeadingChanged();
      // },
      _htmlContentChanged: function(a, b) {
        console.log('_htmlcontentchanged', a, b);
      },

      _currHeadingChanged: function() {
        if (!this.currCode || !this.htmlContent || !this._codeMirror)
          return;
        this.displayContent = this.currCode[this.currHeading];
        if (this.displayContent)
          this._codeMirror.setValue(this.displayContent);
      },

      _demoHeightChanged: function() {
        if (!this.$.frame)
          return;

        this.$.frame.style.height = this._demoHeight.toString() + 'px';
      }


    });


  </script>
</dom-module>
